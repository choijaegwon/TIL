# iOSInAppPurchase 구현 가이드라인
## 제품 유형
---
|제품|설명|예시|
|------|--------|---|
|소모성 제품|한 번 사용하면 소모되며 다시 구입가능|게임에서 진일보하기 위한 생명 또는 보석, 소개팅 앱에서 프로필의 노출을 높여주는 아이템|
|비소모성 제품|구입시 영구적으로 사용가능|사진 앱의 추가 필터, 일러스트레이션 앱의 추가 브러시 또는 게임의 꾸미기용 아이템|
|자동 갱신 구독|앱의 콘텐츠, 서비스 또는 프리미엄 기능에 대한 지속적인 이용 권한 특정 주기별로 자동 결제|미디어 또는 콘텐츠 라이브러리, 넷플릭스 등|
|비갱신형 구독|한정된 기간 동안 서비스 또는 콘텐츠에 대한 이용 권한을 제공 기간이 끝나면 다시 사용자가 결제를 해야함|게임의 시즌 패스권|

- 소모성 제품 제외 **구매 항목은 Apple에서 관리**
- 비소모성 제품과, 자동 갱신 구독  StoreKit을 이용해서 Apple server와 통신해서 상품을 복구해야한다.
- 배깅신형 구독은 Apple과의 통신 없이 서비스 서버에서 상품을 복구해야한다.
- 비소모성 제품과, 자동 갱신 구독은 Apple에서 복구를 지원한다. 
자동으로 되는 건 아니고 Application내에 shop 페이지 어딘가에 복구 버튼을 놓고 Store Kit 을 이용해서 개발해야 한다. 복구 버튼이 없으면 앱스토어 리뷰 과정에서 리젝(reject) 사유가 될 수 있다.
- 비갱신형 구독은 복구을 해줘야 하는 상품이지만 정작 apple server에서는 복구 지원을 해주지 않는다. 
따라서 자체 서비스 서버를 통해 인앱 결제시에 사용자를 식별할 수 있는 정보를 저장하여 복구 기능을 구현해야한다. (복구를 지원한다기 보다는 계정에서 구매 정보를 유지해 주면 되는 형태이다.) [애플 도큐먼트](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Chapters/Products.html)의 아래 글을 보면 명확하다.

## [소모성, 비소모성 제품]

---

- 앱 내 크레딧은 사용 만료 기한이 없어야하며, 결제 복원이 가능해야한다.(구매 항복 복원 버튼의 구현이 필요)
- 비소모성 제품의 경우 ~일 체험을 만들수 있다.

## [자동 갱신 구독]

---

- StoreKit API 사용
- 구독 기간은 최소7일
- 각 구독 제품을 구독 그룹의 일부로 생성하고 등급 지정가능
    
    → 앱에서 여러 개의 구독을 구입하는 기능을 제공해야 하는 경우(예: 스트리밍 앱에서 둘 이상의 채널 구독), 해당 구독을 각각 다른 그룹에 추가할 수 있습니다. 여러 그룹에서 구독을 구입한 사람은 각 구독에 대해 개별적으로 비용이 청구됩니다. 사용자가 하나의 그룹에서 구독을 취소한 후 다른 그룹에서 새 구독을 구입하는 경우 갱신일이 변경되고 유료 서비스 사용 기간이 재설정됩니다.
    
    [무료 체험 버전은 최소 3일부터 시작.](https://help.apple.com/app-store-connect/?lang=ko#/deve1d49254f)
    
- 완납 결제
    
    완납 결제를 선택하면 고객이 선택한 기간에 대해 1회 할인 가격(예를 들어, 9.99달러의 표준 가격이 적용되는 구독에 대해 2개월 1.99달러)을 지불합니다.
    
    기간은 다음 중에 선택할 수 있습니다: 1개월, 2개월, 4개월, 1년
    

## [구독 프로모션 제공]

---

- 자동 갱신 구독에는 특정 기간 동안 무료 또는 할인된 가격을 제공

|제품|설명|
|------|--------|
| 무료 | 구독자는 특정 기간 동안 무료로 구독을 체험가능 (최소 3일) |
| 분납 결제 | 구독자는 특정 기간 동안 매 청구 기간에 할인된 가격으로 결제 |
| 완납 결제 | 구독자는 특정 기간 동안 한 번의 특가로 결제 |

## [프로모션 유형]

---

|제품|설명|
|------|--------|
| 신규 구독 프로모션| 신규 구독자가 정상가를 지불하기 전에 구독을 경험가능 <br> 각 그룹당 1개의 신규 구독 프로모션 제공 가능 |
| 프로모션 특가 | 기존 또는 이전 구독자에게 특정 기간 동안 무료 또는 할인된 가격으로 구독을 제공 <br>구독을 취소한 고객을 재확보 <br> 특별 가격에 다른 구독으로 업그레이드하도록 홍보 <br> 현재 구독 기간이 끝나기 전에 구독자를 재확보할 수 있도록 1개월 무료 프로모션 특가를 표시가능 |
| 프로모션 코드 | 제한된 시간 동안 할인된 가격 또는 무료로 제공 |

## [프로모션 코드]

---

- 사용자가 직접 등록하는 쿠폰 입력창이 앱 내에 존재하지 않아야 한다.

|제품|설명|
|------|--------|
| 일회용 코드 | 앱 내에서 일회성 URL을 통해 사용 <br> App Store 코드 사용 절차에서 코드를 입력하여 사용 |
| 맞춤형 코드 | 고유한 이름을 붙인 맞춤형 코드(예: SPRINGPROMO)로 각 코드는 일회용 URL을 통해 사용 <br> 앱 내에서 사용 <br> 최대 사용 한도를 설정하고, 만료일을 설정할 것인지 선택가능 |
- 프로모션 코드는 다음과 같이 다양한 방법으로 사용가능
    - 현재 또는 사용 중단한 구독자에게 제한된 시간 동안 서비스를 경험하도록 프로모션 코드와 함께 최신 기능 및 최근에 추가된 콘텐츠를 공유하는 이메일을 보낼 수 있습니다.
    - 이벤트 참석자에게 서비스 홍보를 위해 맞춤형 코드가 포함된 전단지를 배포할 수 있습니다.
    - 앱 홍보를 위해 다른 회사와 협력하여 마케팅 기획이나 캠페인을 진행할 수 있습니다.
    - 현재 구독자가 프로모션 코드를 공유하고 앱 홍보에 따른 혜택을 받을 수 있는 P2P 멤버 추천 프로그램을 생성해 보십시오. 구독자에게 혜택이나 보상을 제공해야 할 책임은 개발자에게 있습니다.
    - 고객 서비스 문제를 겪은 구독자에게 해당 문제에 대한 보상을 제공하고 구독 유지를 권유하기 위해 코드를 제공할 수 있습니다.
    - 서비스 중단 예정인 앱 내에서 일회용 코드를 배포하여 현재 구독자를 새 앱으로 전환하고 서비스 홍보를 할 수 있습니다.
- 일회용 코드는 생성일로부터 최대 6개월 후에 만료

## [구독 수수료]

---

- 구독 수수료
    
    기본은 인앱 결제 수수료는 **30%** 
    한 유저가 1년이상 지속적으로 결제하는 경우(유지하는 경우) 해당 유저 수수료만 **15%**로 인하
    (중간에 결제 취소한 경우 60일이 지나면 결제 기간 누적이 취소된다.) 
    60일 이내에 다시 정기 결제를 시작한 경우 결제기간은 누적이 된다.
    Ex) 1월에 구독후 3월에 구독취소 4월에 구독시작 후 1월이 되어도 1년을 유지한걸로 취급.
    
- 실제 수익금 = **매출 – 수수료 – (세금)**

## 기타 참고사항

---

- 앱 내 구입 이외의 구입 메커니즘으로 안내하는 버튼, 외부 링크나 다른 동작 호출이 있으면 안됨
- 가상 서비스 재화 등의 경우 **쿠폰 코드 입력 화면도 사용할 수 없다.
→** 일부 게임, 앱 등에서는 쿠폰 코드 입력 화면을 홈페이지의 고객센터 안쪽 링크로 감추거나, 
심사 시에만 메뉴를 감추는 방법으로 우회 구현가능
- 비갱신형 구독이용시 게임의 무료시즌권 이후  [회원가입을 요구하면 리젝당할 가능성이 있다.](https://stackoverflow.com/questions/17609347/restore-transactions-for-non-renewing-subscriptions-without-registration)
- 자동갱신 구독에서 무료 평가판으로 구독하고
구독하는 도중에 구독을 취소하면 무료 평가판이기 때문에 결제가 이루어 지지않음.

### References
---
https://blog.yousoro.moe/archives/383    
https://steemit.com/kr/@yjiq150/ios-iap-auto-renewable-subscription   
https://developer.apple.com/kr/in-app-purchase  
https://developer.apple.com/kr/app-store/subscriptions/#providing-subscription-offers   
https://help.apple.com/app-store-connect/?lang=ko#/dev2acb77fcc  
https://developer.apple.com/documentation/storekit/in-app_purchase/original_api_for_in-app_purchase/subscriptions_and_offers/implementing_introductory_offers_in_your_app  